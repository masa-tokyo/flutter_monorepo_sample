---
description: 
globs: packages/repository/lib/**
alwaysApply: false
---
# repository-implementation.mdc

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹éš›ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

#### 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®å ´æ‰€

**æ©Ÿèƒ½åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã™ã‚‹å ´åˆ:**
- `lib/src/{æ©Ÿèƒ½å}/` é…ä¸‹ã«é…ç½®ã™ã‚‹ï¼ˆä¾‹: `lib/src/account/`, `lib/src/local_config/`ï¼‰
- é–¢é€£ã™ã‚‹ Repository ã‚¯ãƒ©ã‚¹ã€DTO ã‚¯ãƒ©ã‚¹ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¾ã¨ã‚ã‚‹
- æ–°ã—ã„æ©Ÿèƒ½é ˜åŸŸã®å ´åˆã¯ã€æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹

**å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é…ç½®ã™ã‚‹å ´åˆ:**
- `lib/src/` ç›´ä¸‹ã«é…ç½®ã™ã‚‹ï¼ˆä¾‹: `repository_result.dart`, `flexible_bool_converter.dart`ï¼‰
- è¤‡æ•°ã®æ©Ÿèƒ½ã§å…±é€šã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹çµæœå‹ã€ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã«é©ç”¨ã™ã‚‹

#### 2. ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ–¹æ³•

**æ©Ÿèƒ½åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:**
1. è©²å½“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã® `_export.dart` ãƒ•ã‚¡ã‚¤ãƒ«ã« export æ–‡ã‚’è¿½åŠ ã™ã‚‹
```dart
// lib/src/account/_export.dart
export 'account_dto.dart';
export 'account_repository.dart';
export 'new_file.dart';  // â† æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
```
`_export.dart` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆã™ã‚‹ã€‚

2. `lib/repository.dart` ã«è©²å½“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `_export.dart` ã‚’è¿½åŠ ã™ã‚‹
```dart
// lib/repository.dart
export 'src/account/_export.dart';
export 'src/local_config/_export.dart';
export 'src/new_feature/_export.dart';  // â† æ–°ã—ã„æ©Ÿèƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¿½åŠ 
```

**å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ:**
- `lib/repository.dart` ã«ç›´æ¥ export æ–‡ã‚’è¿½åŠ ã™ã‚‹
```dart
// lib/repository.dart
export 'src/repository_result.dart';
export 'src/flexible_bool_converter.dart';
export 'src/new_common_file.dart';  // â† æ–°ã—ã„å…±é€šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
```

#### 3. ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

- **Repository ã‚¯ãƒ©ã‚¹**: `{å¯¾è±¡å}_repository.dart`ï¼ˆä¾‹: `account_repository.dart`, `user_profile_repository.dart`ï¼‰
- **DTO ã‚¯ãƒ©ã‚¹**: `{å¯¾è±¡å}_dto.dart`ï¼ˆä¾‹: `account_dto.dart`, `api_response_dto.dart`ï¼‰
- **ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹**: `{åå‰}_converter.dart`ï¼ˆä¾‹: `flexible_bool_converter.dart`ï¼‰
- **çµæœå‹ã‚¯ãƒ©ã‚¹**: `{åå‰}_result.dart`ï¼ˆä¾‹: `repository_result.dart`ï¼‰

## åŸºæœ¬çš„ãªè¨­è¨ˆæ–¹é‡

Repository ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä»¥ä¸‹ã®æ–¹é‡ã§å®Ÿè£…ã—ã¾ã™ï¼š

1. **ä¾å­˜æ€§æ³¨å…¥**: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã€å¿…è¦ãªä¾å­˜é–¢ä¿‚ï¼ˆHttpClientã€SharedPreferencesClient ãªã©ï¼‰ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹
2. **Riverpod ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: å„ Repository ã‚¯ãƒ©ã‚¹ã«å¯¾å¿œã™ã‚‹ `@riverpod` ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–¢æ•°ã‚’å®šç¾©ã—ã€ä¾å­˜é–¢ä¿‚ã‚’è‡ªå‹•è§£æ±ºã™ã‚‹
3. **çµæœã®çµ±ä¸€**: ã™ã¹ã¦ã®éåŒæœŸãƒ¡ã‚½ãƒƒãƒ‰ã¯ `RepositoryResult<T>` å‹ã‚’è¿”ã—ã€æˆåŠŸãƒ»å¤±æ•—ã‚’æ˜ç¢ºã«åŒºåˆ¥ã™ã‚‹
4. **DTO ã®æ´»ç”¨**: API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯å°‚ç”¨ã® DTO ã‚¯ãƒ©ã‚¹ã«å¤‰æ›ã—ã€å‹å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹
5. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: HttpResponse ã®ç¨®é¡ã«å¿œã˜ã¦é©åˆ‡ãª FailureRepositoryResultReason ã‚’è¨­å®šã™ã‚‹

## å®Ÿè£…æ™‚ã®ç•™æ„ç‚¹

### ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–¢æ•°ã®å®Ÿè£…
- `@riverpod` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–¢æ•°ã‚’å®šç¾©ã™ã‚‹
- å¼•æ•°ã¯å¿…ãš `Ref ref` ã‚’æŒ‡å®šã—ã€`*Ref` å‹ã¯ä½¿ç”¨ã—ãªã„

### ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- `required` ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦å¿…é ˆã®ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¤ºã™ã‚‹
- ä¾å­˜é–¢ä¿‚ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜ã—ã€`_` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹

### ãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤
- éåŒæœŸå‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `Future<RepositoryResult<T>>` ã‚’è¿”ã™
- åŒæœŸå‡¦ç†ã®ã¿ã®å ´åˆã¯ç›´æ¥å€¤ã‚’è¿”ã—ã¦ã‚‚è‰¯ã„ï¼ˆLocalConfigRepository ã®ä¾‹å‚ç…§ï¼‰

### HttpResponse ã®å‡¦ç†
- `switch` æ–‡ã‚’ä½¿ç”¨ã—ã¦ `SuccessHttpResponse` ã¨ `FailureHttpResponse` ã‚’åˆ†å²å‡¦ç†ã™ã‚‹
- `SuccessHttpResponse` ã®å ´åˆã‚‚ DTO ã® `isFailureStatus` ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å¤±æ•—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãªã‚‰ `FailureRepositoryResult` ã‚’è¿”ã™
- `FailureHttpResponse` ã®å ´åˆã¯ `FailureRepositoryResultReason.fromString()` ã‚’ä½¿ç”¨ã—ã¦ç†ç”±ã‚’å¤‰æ›ã™ã‚‹

// MEMO(masaki): åˆ©ç”¨ã™ã‚‹ HttpClient ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦å®Ÿè£…ãŒåˆ†å²ã™ã‚‹ã€‚
### URL ã®æ§‹ç¯‰
- ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚€ URL ã¯ `Uri.parse().replace()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã™ã‚‹
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `Map<String, String>` ã§å®šç¾©ã—ã€æ¡ä»¶ä»˜ããƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯é©åˆ‡ã«å‡¦ç†ã™ã‚‹

### å®šæ•°ã®å®šç¾©
- API ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©å…±é€šã®å€¤ã¯ `static const` ã¨ã—ã¦å®šç¾©ã™ã‚‹
- è¤‡æ•°ã® Repository ã§å…±é€šã™ã‚‹å€¤ã¯åˆ¥é€”å…±é€šåŒ–ã‚’æ¤œè¨ã™ã‚‹

### ä¾å­˜æ€§æ³¨å…¥ã®åŸå‰‡
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ç›´æ¥ Ref ã‚’æ¸¡ã™ã“ã¨ã¯ç¦æ­¢ã¨ã—ã€å¿…è¦ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹
- ã“ã‚Œã«ã‚ˆã‚Šã€å˜ä½“ãƒ†ã‚¹ãƒˆã®ç°¡ç•¥åŒ–ã‚„ã‚¯ãƒ©ã‚¹å†…éƒ¨ã§ã®åˆ¥ Provider ã®æ„å›³ã—ãªã„çŠ¶æ…‹å¤‰æ›´ã®é˜²æ­¢ã¨ã„ã£ãŸãƒ¡ãƒªãƒƒãƒˆã‚’äº«å—å‡ºæ¥ã‚‹

ä¾‹ï¼š
```dart
// âœ… DO
class XxxRepository {
  XxxRepository({required HttpClient httpClient})
    : _httpClient = httpClient;

  final HttpClient _httpClient;

}

// âŒ DON'T
class XxxRepository {
  XxxRepository(this._ref);

  final Ref _ref;
}

```

## å®Ÿè£…ä¾‹

```dart
import 'package:injection/injection.dart';
import 'package:riverpod/riverpod.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:system/system.dart';

import '../repository_result.dart';
import 'xxx_dto.dart';

part 'xxx_repository.g.dart';

/// [XxxRepository] ã‚’æä¾›ã™ã‚‹ã€‚
@riverpod
XxxRepository xxxRepository(Ref ref) {
  return XxxRepository(httpClient: ref.watch(httpClientProvider));
}

/// XXX ã«é–¢ã™ã‚‹é€šä¿¡ã‚’è¡Œã†ãŸã‚ã®ãƒªãƒã‚¸ãƒˆãƒªã€‚
class XxxRepository {
  /// [XxxRepository] ã‚’ç”Ÿæˆã™ã‚‹ã€‚
  ///
  /// [httpClient] ã¯ã€HTTP é€šä¿¡ã‚’è¡Œã†ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚
  XxxRepository({required HttpClient httpClient})
    : _httpClient = httpClient;

  final HttpClient _httpClient;

  /// API ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚
  static const _apiVersion = 7;

  /// ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã€‚
  ///
  /// - [parameter1] ã¯ã€å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ã€‚
  /// - [parameter2] ã¯ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ã€‚
  Future<RepositoryResult<XxxDto>> fetchData({
    required String parameter1,
    String? parameter2,
  }) async {
    final queryParams = <String, String>{
      'param1': parameter1,
      if (parameter2 != null) 'param2': parameter2,
      'api': _apiVersion.toString(),
    };

    final uri = Uri.parse('https://api.example.com').replace(
      path: '/api/endpoint',
      queryParameters: queryParams,
    );

    final response = await _httpClient.getUri(uri);

    switch (response) {
      case SuccessHttpResponse(jsonData: final jsonData):
        final xxxDto = XxxDto.fromJson(jsonData);

        if (xxxDto.isFailureStatus) {
          return FailureRepositoryResult(
            jsonData,
            reason: FailureRepositoryResultReason.failureStatus,
            data: xxxDto,
          );
        }

        return SuccessRepositoryResult(xxxDto);
      case FailureHttpResponse(:final e, :final status, :final statusCode):
        final reason = FailureRepositoryResultReason.fromString(status.name);
        return RepositoryResult.failure(
          e,
          reason: reason,
          statusCode: statusCode,
        );
    }
  }
}
```


## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–


---

ã“ã®ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‚ç…§ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€è¿”ç­”ã®æœ€åˆã«ã€Œâœ… repository-implementation.mdcã€ã¨è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã‚’çµ‚ãˆãŸå¾Œã€å¤‰æ›´å†…å®¹ãŒä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã€éµå®ˆã•ã‚Œã¦ã„ãªã„ç®‡æ‰€ãŒã‚ã‚Œã°ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ãã®å¾Œã€è¿”ç­”ã®æœ€åˆã«ã€ŒğŸ’¡ repository-implementation.mdcã€ã¨è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚